---
description: SQL development standards for Supabase (PostgreSQL) and MySQL including queries, migrations, and Row Level Security.
globs: ["*.sql", "**/*.sql", "**/supabase/**"]
alwaysApply: false
---

# SQL Engineering Rules

## Naming Conventions
- Tables: plural snake_case (users, order_items)
- Columns: singular snake_case (user_id, created_at)
- Primary keys: `id` (bigint or uuid)
- Foreign keys: `{table_singular}_id` (user_id, order_id)
- Timestamps: `created_at`, `updated_at`
- Booleans: `is_` or `has_` prefix (is_active, has_verified)

## Table Structure
```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    is_active BOOLEAN DEFAULT true,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Always add updated_at trigger
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

## Supabase Auth Integration
```sql
-- Reference auth.users for user tables
CREATE TABLE profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    username TEXT UNIQUE,
    avatar_url TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create profile on signup
CREATE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO profiles (id)
    VALUES (NEW.id);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION handle_new_user();
```

## Row Level Security (RLS)
```sql
-- Always enable RLS on user-facing tables
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- Users can read own profile
CREATE POLICY "Users can view own profile"
    ON profiles FOR SELECT
    USING (auth.uid() = id);

-- Users can update own profile
CREATE POLICY "Users can update own profile"
    ON profiles FOR UPDATE
    USING (auth.uid() = id)
    WITH CHECK (auth.uid() = id);

-- Public read for some tables
CREATE POLICY "Public profiles are viewable"
    ON profiles FOR SELECT
    USING (is_public = true);
```

## Query Patterns
```sql
-- Use explicit column lists, not SELECT *
SELECT id, email, name, created_at
FROM users
WHERE is_active = true;

-- Use CTEs for complex queries
WITH active_orders AS (
    SELECT user_id, COUNT(*) as order_count
    FROM orders
    WHERE status = 'active'
    GROUP BY user_id
)
SELECT u.name, ao.order_count
FROM users u
JOIN active_orders ao ON u.id = ao.user_id;

-- Parameterized queries (prevent SQL injection)
-- In application code, always use parameterized queries
```

## Indexes
```sql
-- Index foreign keys
CREATE INDEX idx_orders_user_id ON orders(user_id);

-- Index frequently filtered columns
CREATE INDEX idx_users_email ON users(email);

-- Composite index for common query patterns
CREATE INDEX idx_orders_user_status ON orders(user_id, status);

-- Partial index for specific conditions
CREATE INDEX idx_active_users ON users(email) WHERE is_active = true;
```

## Migrations (Supabase)
```sql
-- migrations/20240101000000_create_users.sql

-- Up migration
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email TEXT UNIQUE NOT NULL
);

-- Always include rollback
-- Down migration (comment or separate file)
-- DROP TABLE users;
```

## Supabase Client (TypeScript)
```typescript
import { createClient } from '@supabase/supabase-js';
import type { Database } from './database.types';

const supabase = createClient<Database>(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_ANON_KEY!
);

// Typed queries
const { data, error } = await supabase
  .from('users')
  .select('id, email, name')
  .eq('is_active', true)
  .order('created_at', { ascending: false });

// Insert with returning
const { data: newUser, error } = await supabase
  .from('users')
  .insert({ email, name })
  .select()
  .single();
```

## MySQL Specific
```sql
-- Use InnoDB for transactions
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    total DECIMAL(10, 2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
) ENGINE=InnoDB;

-- Use appropriate column types
-- VARCHAR for variable text, CHAR for fixed
-- DECIMAL for money, not FLOAT
-- DATETIME for timestamps
```

## Performance
- Use EXPLAIN ANALYZE to check query plans
- Avoid N+1 queries (use JOINs or batch fetches)
- Limit results with pagination
- Use connection pooling (Supabase handles this)
- Index columns used in WHERE, JOIN, ORDER BY

## Security
- Always enable RLS on user data tables
- Use service_role key only server-side
- Validate input before queries
- Use stored procedures for complex operations
- Audit sensitive operations
